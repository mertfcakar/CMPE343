<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.Button?>
<?import javafx.scene.control.ComboBox?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.ListView?>
<?import javafx.scene.control.PasswordField?>
<?import javafx.scene.control.ScrollPane?>
<?import javafx.scene.control.TableColumn?>
<?import javafx.scene.control.TableView?>
<?import javafx.scene.control.TextField?>
<?import javafx.scene.effect.DropShadow?>
<?import javafx.scene.layout.BorderPane?>
<?import javafx.scene.layout.FlowPane?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.Region?>
<?import javafx.scene.layout.StackPane?>
<?import javafx.scene.layout.VBox?>
<?import javafx.scene.text.Font?>

<StackPane prefHeight="800" prefWidth="1200" style="-fx-background-color: #f4f6f8;"
    xmlns="http://javafx.com/javafx/21" xmlns:fx="http://javafx.com/fxml/1"
    fx:controller="com.group12.greengrocer.controllers.CustomerController">

    <!-- ANA Ä°Ã‡ERÄ°K (Arka Plan) -->
    <BorderPane fx:id="mainContent">
        <top>
            <HBox alignment="CENTER_LEFT" spacing="20"
                style="-fx-background-color: #2e7d32; -fx-padding: 15 25;">
                <effect>
                    <DropShadow color="rgba(0,0,0,0.2)" offsetY="2" />
                </effect>
                <Label style="-fx-text-fill: white; -fx-font-size: 24px; -fx-font-weight: bold;"
                    text="GreenGrocer" />
                <Region HBox.hgrow="ALWAYS" />

                <!-- Arama ve SÄ±ralama -->
                <HBox alignment="CENTER" spacing="10">
                    <HBox alignment="CENTER" spacing="5"
                        style="-fx-background-color: white; -fx-background-radius: 20; -fx-padding: 5 15;">
                        <TextField fx:id="searchField" onKeyReleased="#handleSearch" prefWidth="200"
                            promptText="Search product..." style="-fx-background-color: transparent;" />
                        <Button onAction="#handleClearSearch"
                            style="-fx-background-color: transparent; -fx-text-fill: #999; -fx-cursor: hand;"
                            text="X" />
                    </HBox>
                    <!-- SIRALAMA KUTUSU -->
                    <ComboBox fx:id="sortComboBox" prefHeight="35" promptText="Sort"
                        style="-fx-background-radius: 20; -fx-background-color: #a5d6a7;" />
                </HBox>

                <Region prefWidth="20" />
                <Label fx:id="usernameLabel" style="-fx-text-fill: white; -fx-font-weight: bold;"
                    text="User" />
                <Button onAction="#handleLogout"
                    style="-fx-background-color: #c62828; -fx-text-fill: white; -fx-background-radius: 5; -fx-cursor: hand;"
                    text="Logout" />
            </HBox>
        </top>

        <left>
            <VBox prefWidth="240" spacing="0"
                style="-fx-background-color: white; -fx-border-color: #e0e0e0; -fx-border-width: 0 1 0 0;">
                <VBox alignment="CENTER" spacing="10"
                    style="-fx-padding: 20; -fx-background-color: #e8f5e9;">
                    <Label style="-fx-font-weight: bold; -fx-text-fill: #2e7d32;" text="MY CART" />
                    <Label fx:id="cartItemsLabel"
                        style="-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: #1b5e20;"
                        text="0 items" />
                    <Button maxWidth="Infinity" onAction="#handleViewCart"
                        style="-fx-background-color: #2e7d32; -fx-text-fill: white; -fx-font-weight: bold; -fx-background-radius: 20; -fx-cursor: hand; -fx-padding: 10;"
                        text="Go to Cart" />
                </VBox>
                <VBox spacing="5" style="-fx-padding: 10;">
                    <Button maxWidth="Infinity" onAction="#handleViewOrders"
                        style="-fx-background-color: transparent; -fx-alignment: center-left; -fx-padding: 12; -fx-cursor: hand;"
                        text="ðŸ“¦  My Orders" />
                    <Button maxWidth="Infinity" onAction="#handleOpenChat"
                        style="-fx-background-color: transparent; -fx-alignment: center-left; -fx-padding: 12; -fx-cursor: hand;"
                        text="ðŸ’¬  Support / Messages" />
                    <Button maxWidth="Infinity" onAction="#handleEditProfile"
                        style="-fx-background-color: transparent; -fx-alignment: center-left; -fx-padding: 12; -fx-cursor: hand;"
                        text="ðŸ‘¤  Edit Profile" />
                </VBox>
            </VBox>
        </left>

        <center>
            <ScrollPane fitToWidth="true"
                style="-fx-background-color: transparent; -fx-background: transparent;">
                <VBox spacing="30" style="-fx-padding: 30;">
                    <VBox spacing="15">
                        <Label
                            style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #37474f;"
                            text="ðŸŒ¿ Fresh Vegetables" />
                        <FlowPane fx:id="vegetablesFlowPane" hgap="20" vgap="20" />
                    </VBox>
                    <VBox spacing="15">
                        <Label
                            style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #37474f;"
                            text="ðŸŽ Fresh Fruits" />
                        <FlowPane fx:id="fruitsFlowPane" hgap="20" vgap="20" />
                    </VBox>
                </VBox>
            </ScrollPane>
        </center>
    </BorderPane>

    <!-- OVERLAY CONTAINER (POPUP KATMANI) -->
    <StackPane fx:id="overlayContainer" style="-fx-background-color: rgba(0,0,0,0.4);"
        visible="false">

        <!-- 1. SÄ°PARÄ°ÅžLER -->
        <VBox fx:id="ordersOverlay" maxHeight="500" maxWidth="850" spacing="10"
            style="-fx-background-color: white; -fx-background-radius: 10; -fx-padding: 20;">
            <effect>
                <DropShadow color="rgba(0,0,0,0.5)" radius="20" />
            </effect>
            <HBox alignment="CENTER_LEFT">
                <Label style="-fx-font-size: 18px; -fx-font-weight: bold;" text="Order History" />
                <Region HBox.hgrow="ALWAYS" />
                <Button onAction="#closeAllOverlays"
                    style="-fx-background-color: transparent; -fx-text-fill: #999; -fx-font-weight: bold; -fx-cursor: hand;"
                    text="âœ• Close" />
            </HBox>
            <TableView fx:id="ordersTable" VBox.vgrow="ALWAYS">
                <columns>
                    <TableColumn fx:id="colId" text="#" />
                    <TableColumn fx:id="colDate" text="Date" prefWidth="120" />
                    <TableColumn fx:id="colTotal" text="Total" />
                    <TableColumn fx:id="colStatus" text="Status" />
                    <TableColumn fx:id="colItems" text="Products" prefWidth="200" />
                    <TableColumn fx:id="colAction" text="Actions" prefWidth="180" />
                </columns>
                <columnResizePolicy>
                    <TableView fx:constant="CONSTRAINED_RESIZE_POLICY" />
                </columnResizePolicy>
            </TableView>
        </VBox>

        <!-- 2. PROFIL -->
        <VBox fx:id="profileOverlay" maxHeight="450" maxWidth="400" spacing="15"
            style="-fx-background-color: white; -fx-background-radius: 10; -fx-padding: 30;">
            <effect>
                <DropShadow color="rgba(0,0,0,0.5)" radius="20" />
            </effect>
            <Label style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #2e7d32;"
                text="Edit Profile" />
            <Label style="-fx-font-weight: bold;" text="Address:" />
            <TextField fx:id="editAddressField" style="-fx-background-radius: 5;" />
            <Label style="-fx-font-weight: bold;" text="Email:" />
            <TextField fx:id="editEmailField" style="-fx-background-radius: 5;" />
            <Label style="-fx-font-weight: bold;" text="Phone:" />
            <TextField fx:id="editPhoneField" style="-fx-background-radius: 5;" />
            <Label style="-fx-font-weight: bold;" text="New Password:" />
            <PasswordField fx:id="editPasswordField" style="-fx-background-radius: 5;" />
            <HBox alignment="CENTER" spacing="10">
                <Button maxWidth="Infinity" onAction="#saveProfile"
                    style="-fx-background-color: #2e7d32; -fx-text-fill: white; -fx-cursor: hand;"
                    text="Save" HBox.hgrow="ALWAYS" />
                <Button maxWidth="Infinity" onAction="#closeAllOverlays"
                    style="-fx-background-color: #ddd; -fx-cursor: hand;" text="Cancel"
                    HBox.hgrow="ALWAYS" />
            </HBox>
        </VBox>

        <!-- 3. GELÄ°ÅžMÄ°Åž CHAT (WHATSAPP TARZI - DÃœZELTÄ°LMÄ°Åž RENKLER) -->
        <HBox fx:id="chatOverlay" maxHeight="600" maxWidth="900"
            style="-fx-background-color: white; -fx-background-radius: 15; -fx-border-radius: 15;">
            <effect>
                <DropShadow color="rgba(0,0,0,0.4)" radius="30" offsetY="10" />
            </effect>

            <!-- SOL MENÃœ: KONULAR -->
            <VBox minWidth="280" spacing="0"
                style="-fx-border-color: #e0e0e0; -fx-border-width: 0 1 0 0; -fx-background-color: #ffffff; -fx-background-radius: 15 0 0 15;">
                <HBox alignment="CENTER_LEFT"
                    style="-fx-padding: 20; -fx-background-color: #f0f2f5; -fx-background-radius: 15 0 0 0; -fx-border-color: #e0e0e0; -fx-border-width: 0 0 1 0;">
                    <Label style="-fx-font-weight: bold; -fx-font-size: 16px; -fx-text-fill: #333;"
                        text="ðŸ’¬ My Messages" />
                </HBox>
                <Button onAction="#handleNewTicket" maxWidth="Infinity" text="+ New Support Request"
                    style="-fx-background-color: #2e7d32; -fx-text-fill: white; -fx-font-weight: bold; -fx-cursor: hand; -fx-padding: 12; -fx-background-radius: 0;" />
                <ListView fx:id="chatTopicsList" VBox.vgrow="ALWAYS"
                    style="-fx-background-color: transparent; -fx-border-width: 0; -fx-padding: 0; -fx-font-size: 13px;" />
            </VBox>

            <!-- SAÄž Ä°Ã‡ERÄ°K: MESAJLAÅžMA -->
            <VBox HBox.hgrow="ALWAYS"
                style="-fx-background-color: #efe7dd; -fx-background-radius: 0 15 15 0;">
                <HBox alignment="CENTER_LEFT" spacing="15"
                    style="-fx-background-color: #f0f2f5; -fx-padding: 15; -fx-background-radius: 0 15 0 0; -fx-border-color: #d1d7db; -fx-border-width: 0 0 1 0;">
                    <VBox>
                        <Label fx:id="chatCurrentTopicLabel" text="General Support"
                            style="-fx-text-fill: #111; -fx-font-weight: bold; -fx-font-size: 16px;" />
                        <Label text="GreenGrocer Support Line"
                            style="-fx-text-fill: #777; -fx-font-size: 11px;" />
                    </VBox>
                    <Region HBox.hgrow="ALWAYS" />
                    <Button onAction="#handleDeleteChat" text="ðŸ—‘ Clear Chat"
                        style="-fx-background-color: #ffebee; -fx-text-fill: #c62828; -fx-font-size: 12px; -fx-cursor: hand; -fx-background-radius: 5;" />
                    <Button onAction="#closeAllOverlays" text="âœ•"
                        style="-fx-background-color: transparent; -fx-text-fill: #555; -fx-font-weight: bold; -fx-font-size: 16px; -fx-cursor: hand;" />
                </HBox>

                <!-- Chat AlanÄ± Arka PlanÄ± (Bej) -->
                <ScrollPane fx:id="chatScroll" fitToWidth="true" fitToHeight="true"
                    style="-fx-background: #efe7dd; -fx-background-color: #efe7dd; -fx-border-width: 0; -fx-padding: 0;"
                    VBox.vgrow="ALWAYS">
                    <content>
                        <VBox fx:id="chatMessagesBox" spacing="15"
                            style="-fx-padding: 20; -fx-background-color: #efe7dd;" />
                    </content>
                </ScrollPane>

                <HBox spacing="10"
                    style="-fx-padding: 15; -fx-background-color: #f0f2f5; -fx-background-radius: 0 0 15 0; -fx-border-color: #d1d7db; -fx-border-width: 1 0 0 0;">
                    <TextField fx:id="chatInput" promptText="Type a message..."
                        style="-fx-background-radius: 20; -fx-background-color: white; -fx-border-color: white; -fx-padding: 10;"
                        HBox.hgrow="ALWAYS" />
                    <Button onAction="#sendMessage" text="âž¤"
                        style="-fx-background-color: #2e7d32; -fx-text-fill: white; -fx-background-radius: 50; -fx-cursor: hand; -fx-font-size: 14px; -fx-min-width: 40; -fx-min-height: 40;" />
                </HBox>
            </VBox>
        </HBox>

        <!-- 4. SÄ°PARÄ°Åž DETAY PENCERESÄ° -->
        <VBox fx:id="orderDetailOverlay" maxHeight="600" maxWidth="500" spacing="10"
            style="-fx-background-color: white; -fx-background-radius: 10; -fx-padding: 20;"
            visible="false">
            <effect>
                <DropShadow color="rgba(0,0,0,0.5)" radius="20" />
            </effect>
            <HBox alignment="CENTER_LEFT" spacing="10"
                style="-fx-border-color: #eee; -fx-border-width: 0 0 1 0; -fx-padding: 0 0 10 0;">
                <Label style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #2e7d32;"
                    text="Order Contents" />
                <Region HBox.hgrow="ALWAYS" />
                <Button onAction="#closeAllOverlays"
                    style="-fx-background-color: transparent; -fx-text-fill: #999; -fx-font-weight: bold; -fx-cursor: hand; -fx-font-size: 14px;"
                    text="âœ•" />
            </HBox>
            <Label fx:id="detailOrderIdLabel" style="-fx-text-fill: #777; -fx-font-size: 12px;"
                text="Order Details" />
            <ScrollPane fitToWidth="true"
                style="-fx-background-color: transparent; -fx-background: transparent;"
                VBox.vgrow="ALWAYS">
                <VBox fx:id="orderDetailContainer" spacing="10" style="-fx-padding: 5;" />
            </ScrollPane>
            <Button maxWidth="Infinity" onAction="#closeAllOverlays"
                style="-fx-background-color: #2e7d32; -fx-text-fill: white; -fx-font-weight: bold; -fx-cursor: hand; -fx-background-radius: 5;"
                text="Close" />
        </VBox>

    </StackPane>

</StackPane>
